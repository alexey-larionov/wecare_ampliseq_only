Sys.time()
rm(list=ls())
graphics.off()
library(knitr)
library(dplyr)
library(ggplot2)
base_folder="/Users/alexey/Documents/wecare/ampliseq/v04_ampliseq_nfe/s10_remove_duplicates"
opts_knit$set(root.dir = base_folder)
options(stringsAsFactors = F)
options(warnPartialMatchArgs = T,
warnPartialMatchAttr = T,
warnPartialMatchDollar = T)
#options(error = browser()) # Type Q or c to exit, drop browser level
# https://support.rstudio.com/hc/en-us/articles/200713843?version=1.1.456&mode=desktop
# https://stackoverflow.com/questions/13052522/how-to-leave-the-r-browser-mode-in-the-console-window/13052588
source_folder="/Users/alexey/Documents/wecare/ampliseq/v04_ampliseq_nfe/s09_add_phenotypes"
load(paste(source_folder, "s01_add_phenotypes.RData", sep="/"))
base_folder="/Users/alexey/Documents/wecare/ampliseq/analysis3/s09_remove_duplicates"
rm(source_folder)
ls()
dim(genotypes.mx)
dim(phenotypes.df)
dim(variants.df)
sum(colnames(genotypes.mx) != rownames(phenotypes.df))
sum(rownames(genotypes.mx) != rownames(variants.df))
# Remove common variants
common_vars <- variants.df$init_AF >= 0.05
sum(common_vars)
gt_com.mx <- genotypes.mx[common_vars,]
# Remove common variants
common_vars <- variants.df$init_AF >= 0.05 & variants.df$init_AF <= 0.95
sum(common_vars)
gt_com.mx <- genotypes.mx[common_vars,]
dim(gt_com.mx)
# Initialise concordance matrix
conc.mx <- matrix(NA, ncol=ncol(gt_com.mx), nrow=ncol(gt_com.mx))
colnames(conc.mx) <- colnames(gt_com.mx)
rownames(conc.mx) <- colnames(gt_com.mx)
conc.mx[1:5,1:5]
# Initialise counts matrix
cnts.mx <- matrix(NA, ncol=ncol(gt_com.mx), nrow=ncol(gt_com.mx))
colnames(cnts.mx) <- colnames(gt_com.mx)
rownames(cnts.mx) <- colnames(gt_com.mx)
cnts.mx[1:5,1:5]
# Calculate concordances
for(sample_1 in colnames(gt_com.mx)){
for(sample_2 in colnames(gt_com.mx)){
# Get vectors of variants for both samples
smp1 <- gt_com.mx[,sample_1]
smp2 <- gt_com.mx[,sample_2]
# Calculate concordance
total <- sum(!is.na(smp1) & !is.na(smp2))
concordant <- sum(smp1==smp2, na.rm=T)
concordance_rate <- concordant / total
# Write result
if(sample_1 == sample_2){
NA  -> cnts.mx[sample_1,sample_2]
NA  -> conc.mx[sample_1,sample_2]
}else{
total -> cnts.mx[sample_1,sample_2]
concordance_rate -> conc.mx[sample_1,sample_2]
}
}
}
# Check results
cnts.mx[1:5,1:5]
conc.mx[1:5,1:5]
# Clean-up
rm(common_vars, gt_com.mx, sample_1, sample_2, smp1, smp2,
total, concordant, concordance_rate)
# No missed values (except self-concordance/count)
dim(cnts.mx)
sum(is.na(cnts.mx))
sum(is.na(conc.mx))
hist(cnts.mx)
median(cnts.mx, na.rm=T)
mean(cnts.mx, na.rm=T)
median(cnts.mx)
quantile(cnts.mx, na.rm=T)
hist(conc.mx, ylim=c(0,120000), lab=T)
hist(conc.mx, ylim=c(0,1200000), lab=T)
hist(conc.mx, ylim=c(0,200000), lab=T)
hist(conc.mx[conc.mx > 0.9], lab=T, ylim=c(0,30))
sum(conc.mx == 1, na.rm=T)
# Make list of most similar samples (concordance > 0.9)
conc_cases.mx <- matrix(nrow=0, ncol=4)
c("sample_1","sample_2","count","concordance") -> colnames(conc_cases.mx)
for(sample_1 in rownames(conc.mx)){
for(sample_2 in colnames(conc.mx)){
if(sample_1!=sample_2 & conc.mx[sample_1,sample_2] > 0.9 ){
conc_cases.mx <- rbind(conc_cases.mx, c(sample_1,sample_2,
cnts.mx[sample_1,sample_2],
conc.mx[sample_1,sample_2]))
}
}
}
# Check result
conc_cases.mx
# Heatmaps
heatmap(conc.mx, Rowv=NA, Colv=NA, scale='none',
col = cm.colors(256), labRow=NA, labCol = NA,
main="Cases concordance (common variants)")
heatmap(conc.mx, scale='none',
col = cm.colors(256), labRow=NA, labCol = NA,
main="Cases concordance (common variants, clustered)")
# Clean-up
rm(sample_1, sample_2)
dim(phenotypes.df)
colnames(phenotypes.df)
x <- phenotypes.df["40_S189_L007",] != phenotypes.df["41_S328_L008",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x
x <- phenotypes.df["76_S299_L008",] != phenotypes.df["77_S370_L008",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x <- phenotypes.df["234_S381_L008",] != phenotypes.df["235_S535_L008",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x <- phenotypes.df["244_S175_L007",] != phenotypes.df["245_S59_L007",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x <- phenotypes.df["280_S173_L007",] != phenotypes.df["281_S185_L007",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
phenotypes.df[c("280_S173_L007","281_S185_L007"),x]
x <- phenotypes.df["347_S36_L007",] != phenotypes.df["348_S17_L007",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x <- phenotypes.df["398_S161_L007",] != phenotypes.df["399_S255_L007",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x <- phenotypes.df["436_S178_L007",] != phenotypes.df["437_S177_L007",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x <- phenotypes.df["517_S450_L008",] != phenotypes.df["518_S384_L008",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x <- phenotypes.df["527_S233_L007",] != phenotypes.df["528_S275_L008",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x <- phenotypes.df["539_S288_L008",] != phenotypes.df["540_S461_L008",]
sum(x[5:24]) # exclude long_ids illumina_id illumina_lane Sample_num fields
x <- phenotypes.df["270_S70_L007",] != phenotypes.df["351_S71_L007",]
sum(x[5:21]) # exclude long_ids illumina_id illumina_lane Sample_num fields
phenotypes.df[c("270_S70_L007","351_S71_L007"),x]
x <- phenotypes.df["386_S273_L008",] != phenotypes.df["391_S376_L008",]
sum(x[5:21]) # exclude long_ids illumina_id illumina_lane Sample_num fields
phenotypes.df[c("386_S273_L008","391_S376_L008"),x]
rm(x)
Sys.time()
rm(list=ls())
graphics.off()
library(knitr)
base_folder="/Users/alexey/Documents/wecare/ampliseq/v04_ampliseq_nfe/s10_remove_duplicates"
opts_knit$set(root.dir = base_folder)
options(stringsAsFactors = F)
options(warnPartialMatchArgs = T,
warnPartialMatchAttr = T,
warnPartialMatchDollar = T)
#options(error = browser()) # Type Q or c to exit, drop browser level
# https://support.rstudio.com/hc/en-us/articles/200713843?version=1.1.456&mode=desktop
# https://stackoverflow.com/questions/13052522/how-to-leave-the-r-browser-mode-in-the-console-window/13052588
source_folder="/Users/alexey/Documents/wecare/ampliseq/v04_ampliseq_nfe/s09_add_phenotypes"
load(paste(source_folder, "s01_add_phenotypes.RData", sep="/"))
base_folder="/Users/alexey/Documents/wecare/ampliseq/analysis3/s09_remove_duplicates"
rm(source_folder)
ls()
dim(genotypes.mx)
dim(phenotypes.df)
dim(variants.df)
sum(colnames(genotypes.mx) != rownames(phenotypes.df))
sum(rownames(genotypes.mx) != rownames(variants.df))
all_samples <- colnames(genotypes.mx)
excluded_samples <- c("40_S189_L007","76_S299_L008","234_S381_L008",
"244_S175_L007","348_S17_L007","398_S161_L007",
"436_S178_L007","518_S384_L008","527_S233_L007",
"539_S288_L008","270_S70_L007","351_S71_L007",
"386_S273_L008","391_S376_L008")
retained_samples <- ! all_samples %in% excluded_samples
length(all_samples)
length(excluded_samples)
sum(retained_samples)
rm(all_samples, retained_samples)
genotypes.mx <- genotypes.mx[,!colnames(genotypes.mx) %in% excluded_samples]
phenotypes.df <- phenotypes.df[!rownames(phenotypes.df) %in% excluded_samples,]
sum(colnames(genotypes.mx) != rownames(phenotypes.df))
dim(genotypes.mx)
dim(phenotypes.df)
rm(excluded_samples)
# Function to detect uniform numeric vectors
uniform.udf <- function(x){min(x,na.rm=T) == max(x,na.rm=T)}
# Make the filter
uniform_vars <- apply(genotypes.mx,1,uniform.udf)
sum(uniform_vars)
# Apply filter
variants.df <- variants.df[!uniform_vars,]
genotypes.mx <- genotypes.mx[!uniform_vars,]
sum(rownames(genotypes.mx) != rownames(variants.df))
dim(genotypes.mx)
dim(variants.df)
table(phenotypes.df$cc)
535+197
260+261
521+197
