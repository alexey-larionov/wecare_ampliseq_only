---
title: "s02_remove_nfe"
output: html_document
editor_options: 
  chunk_output_type: console
---

started: AL20Sep2019  
last updated: AL20Sep2019  

# summary  

Remove NFE cases and variants that had been detected in NFE cases only  

Input data: 13,046 variants x 739 cases (541 BC and 198 NFE)  
Output data: 12,276 variants x 541 cases  

# start section

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

```{r set_width, echo=F}

# eval=F

options(width = 999)
# https://stackoverflow.com/questions/36845178/width-of-r-code-chunk-output-in-rmarkdown-files-knitr-ed-to-html

```

```{r start_section}

Sys.time()
rm(list=ls())
graphics.off()

library(knitr)

base_folder="/Users/alexey/Documents/wecare/ampliseq/v05_ampliseq_only/s06_read_vcf_to_r"
opts_knit$set(root.dir = base_folder)
options(stringsAsFactors = F,
        warnPartialMatchArgs = T, 
        warnPartialMatchAttr = T, 
        warnPartialMatchDollar = T)

#options(error = browser()) # Type Q or c to exit, drop browser level
# https://support.rstudio.com/hc/en-us/articles/200713843?version=1.1.456&mode=desktop
# https://stackoverflow.com/questions/13052522/how-to-leave-the-r-browser-mode-in-the-console-window/13052588 

```

# read vcfr  

```{r read_vcfr}

load(paste(base_folder, "s01_read_vcf_to_r.RData", sep="/"))

```

# check_data

```{r start_check}

# List objects
ls()

# Check sizes
dim(gt_add.mx)
dim(gt_num.mx)
dim(gt_chr.mx)
dim(ref.mx)
dim(alt.mx)

dim(gq.mx)
dim(dp.mx)

dim(fixed.df)
colnames(fixed.df)

dim(meta.df)

# Check consistence of rownames and colnames

sum(rownames(gt_add.mx) != rownames(gt_num.mx))
sum(rownames(gt_add.mx) != rownames(gt_chr.mx))
sum(rownames(gt_add.mx) != rownames(ref.mx))
sum(rownames(gt_add.mx) != rownames(alt.mx))
sum(rownames(gt_add.mx) != rownames(gq.mx))
sum(rownames(gt_add.mx) != rownames(dp.mx))

sum(colnames(gt_add.mx) != colnames(gt_num.mx))
sum(colnames(gt_add.mx) != colnames(gt_chr.mx))
sum(colnames(gt_add.mx) != colnames(ref.mx))
sum(colnames(gt_add.mx) != colnames(alt.mx))
sum(colnames(gt_add.mx) != colnames(gq.mx))
sum(colnames(gt_add.mx) != colnames(dp.mx))

sum(rownames(gt_add.mx) != rownames(fixed.df))

```

# Remove NFE samples  

```{r}

head(colnames(gt_chr.mx))
tail(colnames(gt_chr.mx))

739-198
colnames(gt_chr.mx)[541:542]

ampliseq_samples <- c(1:541)
nfe_samples <- c(542:739)

length(ampliseq_samples)
length(nfe_samples)

colnames(gt_chr.mx)[ampliseq_samples]
colnames(gt_chr.mx)[nfe_samples]

gt_add.mx <- gt_add.mx[,ampliseq_samples]
gt_num.mx <- gt_num.mx[,ampliseq_samples]
gt_chr.mx <- gt_chr.mx[,ampliseq_samples]
ref.mx <- ref.mx[,ampliseq_samples]
alt.mx <- alt.mx[,ampliseq_samples]
gq.mx <- gq.mx[,ampliseq_samples]
dp.mx <- dp.mx[,ampliseq_samples]

rm(ampliseq_samples,nfe_samples)

```

# Remove variants with uniform genotypes

```{r update_variants}

# Function to detect uniform numeric vectors
uniform.udf <- function(x){
  if(all(is.na(x))) return(TRUE) # Return T if all are NA
  min(x,na.rm=T)==max(x,na.rm=T)} # Return T if min=max, otherwise return F

# Make the filter
uniform_vars <- apply(gt_add.mx,1,uniform.udf)
sum(uniform_vars)
sum(!uniform_vars)

# Apply filter
gt_add.mx <- gt_add.mx[!uniform_vars,]
gt_num.mx <- gt_num.mx[!uniform_vars,]
gt_chr.mx <- gt_chr.mx[!uniform_vars,]
ref.mx <- ref.mx[!uniform_vars,]
alt.mx <- alt.mx[!uniform_vars,]
gq.mx <- gq.mx[!uniform_vars,]
dp.mx <- dp.mx[!uniform_vars,]
fixed.df <- fixed.df[!uniform_vars,]

# Clean-up
rm(uniform.udf, uniform_vars)

```

# check_data

```{r end_check}

# List objects
ls()

# Check sizes
dim(gt_add.mx)
dim(gt_num.mx)
dim(gt_chr.mx)
dim(ref.mx)
dim(alt.mx)

dim(gq.mx)
dim(dp.mx)

dim(fixed.df)
dim(meta.df)

# Check consistence of rownames and colnames

sum(rownames(gt_add.mx) != rownames(gt_num.mx))
sum(rownames(gt_add.mx) != rownames(gt_chr.mx))
sum(rownames(gt_add.mx) != rownames(ref.mx))
sum(rownames(gt_add.mx) != rownames(alt.mx))
sum(rownames(gt_add.mx) != rownames(gq.mx))
sum(rownames(gt_add.mx) != rownames(dp.mx))

sum(colnames(gt_add.mx) != colnames(gt_num.mx))
sum(colnames(gt_add.mx) != colnames(gt_chr.mx))
sum(colnames(gt_add.mx) != colnames(ref.mx))
sum(colnames(gt_add.mx) != colnames(alt.mx))
sum(colnames(gt_add.mx) != colnames(gq.mx))
sum(colnames(gt_add.mx) != colnames(dp.mx))

sum(rownames(gt_add.mx) != rownames(fixed.df))

```

# save results

```{r save_results}

save.image(paste(base_folder, "s02_remove_nfe.RData", sep="/"))

```

# final section

```{r final_section}

ls()
sessionInfo()
Sys.time()

```
